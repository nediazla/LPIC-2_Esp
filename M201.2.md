# 2. El Kernel de Linux

## 2.1 Componentes del kernel de Linux

El kernel de Linux es un núcleo monolítico modular. Esto significa que incluye un núcleo principal y módulos que pueden cargarse dinámicamente.

### Componentes principales del kernel

### 1. Gestión de procesos
- Scheduler (CFS – Completely Fair Scheduler)
- Gestión de hilos (threads)
- Administración de prioridades (nice, real-time)

Inspección:
```
ps, top, htop
```

### 2. Gestión de memoria
- RAM
- Swap
- Page cache
- Memory mapping (mm)
- Cgroups (control de recursos)

Inspección:
```
cat /proc/meminfo
vmstat
```

### 3. Gestión de dispositivos
Se realiza a través de:
- Drivers incorporados en el kernel
- Módulos (`.ko`) en `/lib/modules/$(uname -r)/`

Listado de módulos cargados:
```
lsmod
```

Información detallada de un módulo:
```
modinfo nombre_modulo
```

### 4. Gestión de sistemas de archivos
Soporta múltiples FS:
- ext4, xfs, btrfs, vfat, ntfs, tmpfs, nfs

Ver FS soportados:
```
cat /proc/filesystems
```

### 5. Networking stack
- Interfaces
- TCP/IP
- netfilter/iptables
- eBPF

Inspección:
```
ip link
ss -tulnp
```

### 6. IPC (Inter-Process Communication)
- Pipes
- Sockets
- Signals
- SysV IPC

### 7. Seguridad
- SELinux / AppArmor
- Capabilities
- Namespaces

---

## 2.2 Compilación de un kernel de Linux

LPIC-2 exige conocer el proceso, aunque en entornos reales pocas veces se compila manualmente.

### Instalar herramientas necesarias
```
apt install build-essential libncurses-dev bison flex libssl-dev libelf-dev
```

### Descargar el código fuente del kernel
```
cd /usr/src
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.tar.xz
tar -xvf linux-6.1.tar.xz
cd linux-6.1
```

### Configurar el kernel

#### Opciones de configuración
```
make menuconfig       # interfaz ncurses
make nconfig          # mejor interfaz ncurses
make xconfig          # interfaz gráfica Qt
make gconfig          # interfaz GTK
```

Para usar configuración existente de la distro:
```
cp /boot/config-$(uname -r) .config
make oldconfig
```

### Compilar el kernel
Compilar kernel:
```
make -j$(nproc)
```

Compilar módulos:
```
make modules
```

Instalar módulos:
```
make modules_install
```

Instalar el kernel:
```
make install
```

### Actualizar GRUB
```
update-grub
```

### Reiniciar en el nuevo kernel
```
reboot
```

Verificar:
```
uname -r
```

---

## 2.3 Gestionar el kernel en tiempo de ejecución y resolución de problemas

### Cargar y descargar módulos

Ver módulos cargados:
```
lsmod
```

Cargar módulo:
```
modprobe nombre_modulo
```

Descargar módulo:
```
modprobe -r nombre_modulo
```

Bloquear un módulo (evitar carga):
```
echo "blacklist nombre_modulo" >> /etc/modprobe.d/blacklist.conf
```

### Información de módulos
```
modinfo nombre_modulo
```

### Parámetros del kernel

Ver parámetros activos:
```
sysctl -a
```

Cambiar parámetro temporal:
```
sysctl net.ipv4.ip_forward=1
```

Persistente:
```
/etc/sysctl.conf
/etc/sysctl.d/*.conf
```

Recargar:
```
sysctl -p
```

### Parámetros del kernel en el arranque (GRUB)

Editar:
```
/etc/default/grub
```

Variable importante:
```
GRUB_CMDLINE_LINUX="quiet splash"
```

Actualizar:
```
update-grub
```

### Ficheros del kernel en /proc

Información de CPU:
```
cat /proc/cpuinfo
```

Información de memoria:
```
cat /proc/meminfo
```

Información del kernel:
```
cat /proc/version
uname -a
```

Uso del scheduler:
```
cat /proc/schedstat
```

### Logs del kernel

Ver todos los mensajes del kernel:
```
dmesg
```

Filtrar errores:
```
dmesg | grep -i error
```

Mensajes actuales de arranque:
```
journalctl -k
```

Errores relacionados con módulos:
```
journalctl -k | grep -i module
```

### Solución de problemas comunes

#### Kernel panic
Causas:
- FS raíz no montable
- drivers incorrectos
- módulos incompatibles
- errores en initramfs

Ver logs:
```
journalctl -b -1
```

Regenerar initramfs:
```
update-initramfs -u -k all
```

#### Módulo no carga
```
modprobe nombre_modulo
journalctl -k | grep nombre_modulo
```

#### Problemas de arranque
```
systemctl --failed
journalctl -b
```

#### IRQ o dispositivo colgado
```
cat /proc/interrupts
dmesg | grep irq
```

