# 3. Inicio del sistema

## 3.1 Personalizar el Sistema de inicio

Linux utiliza diferentes sistemas de inicio, pero LPIC-2 se enfoca en **systemd**, que es el estándar actual en la mayoría de distribuciones modernas.

### Ver el sistema de inicio utilizado
```
ps -p 1 -o comm=
```

### Unidades de systemd

Tipos de unidades:
```
.service
.target
.socket
.timer
.mount
.path
```

### Ver estado del inicio
```
systemd-analyze
systemd-analyze blame
systemd-analyze critical-chain
```

### Ver dependencias de un servicio
```
systemctl list-dependencies ssh.service
```

### Crear un servicio personalizado

Ejemplo: `/etc/systemd/system/mi_servicio.service`
```
[Unit]
Description=Mi servicio personalizado
After=network.target

[Service]
ExecStart=/usr/local/bin/script.sh
Restart=always

[Install]
WantedBy=multi-user.target
```

Activar el servicio:
```
systemctl daemon-reload
systemctl enable mi_servicio.service
systemctl start mi_servicio.service
```

Ver logs:
```
journalctl -u mi_servicio.service
```

### Controlar servicios

Iniciar:
```
systemctl start nginx
```

Detener:
```
systemctl stop nginx
```

Reiniciar:
```
systemctl restart nginx
```

Estado:
```
systemctl status nginx
```

Habilitar/deshabilitar:
```
systemctl enable nginx
systemctl disable nginx
```

### Personalización de targets (antiguos runlevels)

Ver target por defecto:
```
systemctl get-default
```

Cambiar target:
```
systemctl set-default multi-user.target
```

Cambiar al momento:
```
systemctl isolate rescue.target
```

---

## 3.2 Recuperación del sistema

Es fundamental poder recuperar un sistema que no arranca o está dañado.

### Entrar en modo rescate

Modo rescate:
```
systemctl rescue
```

Modo emergencia:
```
systemctl emergency
```

### Recuperación desde GRUB

Editar parámetros del kernel en GRUB:

1. En el menú de GRUB, seleccionar la entrada.
2. Presionar `e`.
3. Encontrar la línea `linux`.
4. Añadir al final:
```
systemd.unit=rescue.target
```
o
```
systemd.unit=emergency.target
```

Iniciar con `Ctrl + X`.

### Montar root manualmente

En modo emergencia, root puede estar montado como solo lectura. Para montarlo en escritura:
```
mount -o remount,rw /
```

### Reparar sistemas de archivos

ext4:
```
fsck /dev/sda1
```

Montar otros discos:
```
mount /dev/sdb1 /mnt
```

### Regenerar initramfs
```
update-initramfs -u -k all
```

### Reparar GRUB

Volver a instalar GRUB en BIOS:
```
grub-install /dev/sda
update-grub
```

En UEFI:
```
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ubuntu
update-grub
```

### Chroot para recuperación

Montar sistema:
```
mount /dev/sda1 /mnt
mount /dev/sda2 /mnt/boot
mount /dev/sda3 /mnt/boot/efi
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys
chroot /mnt
```

Salir:
```
exit
```

---

## 3.3 Sistemas de arranque alternativos

Existen otros sistemas de arranque, aunque systemd es el dominante.

### SysV Init (antiguo)

Scripts en:
```
/etc/init.d/
```

Ejemplos:
```
/etc/init.d/apache2 start
/etc/init.d/ssh stop
```

Runlevels definidos en:
```
/etc/rc*.d/
```

### Upstart

Usado antiguamente en Ubuntu:
```
/etc/init/
```

Ejemplo de servicio Upstart:
```
/etc/init/ssh.conf
```

Comandos:
```
initctl status ssh
initctl start ssh
initctl stop ssh
```

### OpenRC

Popular en Alpine y Gentoo:
```
rc-service sshd start
rc-service sshd status
```

### launchd (no LPIC pero cultural)
Utilizado en macOS, no aparece en examen.

### Bootloaders alternativos

#### GRUB2 (el estándar)
Ya cubierto.

#### LILO (obsoleto, pero aparece en LPIC)
Archivo config:
```
/etc/lilo.conf
```

Instalar LILO:
```
lilo
```

Limitaciones:
- No soporta muchas funcionalidades modernas.
- No es recomendado.

#### systemd-boot

Útil en sistemas UEFI puros:
```
/boot/efi/loader/loader.conf
/boot/efi/loader/entries/*.conf
```

Comandos:
```
bootctl status
bootctl install
```

### Herramientas de diagnóstico de arranque
```
journalctl -b
journalctl -u systemd-logind
dmesg
systemd-analyze plot > boot.svg
```
