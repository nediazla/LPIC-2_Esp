# 4. Sistemas de archivos y dispositivos

## 4.1 Manipular sistemas de archivos Linux

### Ver dispositivos y particiones
```
lsblk
lsblk -f
blkid
fdisk -l
```

### Crear particiones

MBR:
```
fdisk /dev/sda
```

GPT:
```
gdisk /dev/sda
```

Parted (interactivo):
```
parted /dev/sdb
```

### Crear sistemas de archivos

ext4:
```
mkfs.ext4 /dev/sda1
```

xfs:
```
mkfs.xfs /dev/sdb1
```

btrfs:
```
mkfs.btrfs /dev/sdc1
```

vfat:
```
mkfs.vfat /dev/sdd1
```

swap:
```
mkswap /dev/sda2
swapon /dev/sda2
```

### Ver información del sistema de archivos

ext4:
```
tune2fs -l /dev/sda1
```

xfs:
```
xfs_info /dev/sdb1
```

btrfs:
```
btrfs filesystem df /mnt
```

### Montaje y desmontaje
```
mount /dev/sda1 /mnt
umount /mnt
```

Montaje con tipo específico:
```
mount -t xfs /dev/sdb1 /datos
```

Ver sistemas montados:
```
mount
findmnt
cat /proc/mounts
```

### Configuración permanente en /etc/fstab
```
UUID=xxxx-xxxx /datos ext4 defaults 0 2
```

Ver UUIDs:
```
blkid
```

Aplicar fstab sin reiniciar:
```
mount -a
```

---

## 4.2 Manteniendo sistemas de archivos Linux

### Verificar sistemas de archivos

ext4:
```
fsck /dev/sda1
fsck.ext4 /dev/sda1
```

Forzar reparación:
```
fsck -f /dev/sda1
```

NO ejecutar fsck en sistemas montados.

### Programar chequeos automáticos

ext4:
```
tune2fs -c 30 /dev/sda1   # cada 30 montajes
tune2fs -i 2m /dev/sda1   # cada 2 meses
```

Ver configuración:
```
tune2fs -l /dev/sda1 | grep -i check
```

### Montar sistemas de archivos dañados
```
mount -o ro /dev/sda1 /mnt
```

### Herramientas específicas

xfs_repair:
```
xfs_repair /dev/sdb1
```

xfs_check (obsoleto pero LPIC puede referenciarlo):
```
xfs_check /dev/sdb1
```

btrfs scrub:
```
btrfs scrub start /mnt
btrfs scrub status /mnt
```

### Ver estadísticas
```
dumpe2fs /dev/sda1
```

### Gestionar cuotas de usuario/grupo

Instalar:
```
apt install quota
```

Activar en fstab:
```
usrquota,grpquota
```

Comandos:
```
quotacheck -avug
quotaon -avug
edquota usuario
repquota -a
```

---

## 4.3 Creando y configurando opciones de sistemas de archivos

### Opciones de montaje comunes en /etc/fstab

```
defaults
noatime
nodev
nosuid
noexec
ro
rw
user
nouser
```

Ejemplo:
```
UUID=xxxx /datos ext4 defaults,noatime 0 2
```

### Montaje con opciones temporales
```
mount -o noexec /dev/sdb1 /mnt
mount -o remount,rw /
```

### Crear sistemas de archivos con opciones específicas

ext4:
```
mkfs.ext4 -L datos -m 1 /dev/sda1
```

xfs:
```
mkfs.xfs -L logs /dev/sdb1
```

btrfs con subvolúmenes:
```
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
```

### Ajustes avanzados del sistema de archivos ext4

Reservar espacio para root:
```
tune2fs -m 1 /dev/sda1
```

Cambiar etiqueta del FS:
```
e2label /dev/sda1 DATOS
```

### Ajustes avanzados en xfs

Cambiar etiqueta:
```
xfs_admin -L DATOS /dev/sdb1
```

Activar journaling externo (muy avanzado):

```
mkfs.xfs -l logdev=/dev/sdc1 /dev/sdb1
```

### Opciones avanzadas de montaje para seguridad

Evitar ejecución:
```
noexec
```

Evitar SUID:
```
nosuid
```

Evitar creación de dispositivos:
```
nodev
```

Ejemplo seguro:
```
UUID=xxxx /tmp ext4 rw,nodev,nosuid,noexec 0 0
```

### Sistemas de archivos temporales (tmpfs)
```
mount -t tmpfs -o size=1G tmpfs /mnt/tmp
```

Persistente:
```
tmpfs  /cache  tmpfs  size=512M  0  0
```

### Sistemas de archivos en red (NFS)

Montaje:
```
mount -t nfs 192.168.1.10:/datos /mnt
```

Opciones típicas:
```
rw,sync,no_root_squash,insecure
```

### Sistemas de archivos cifrados

LUKS:
```
cryptsetup luksFormat /dev/sda1
cryptsetup luksOpen /dev/sda1 cifrado
mkfs.ext4 /dev/mapper/cifrado
```
