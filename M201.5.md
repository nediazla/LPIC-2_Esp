# 5. Administración avanzada de dispositivos de almacenamiento

## 5.1 Configurando RAID

Linux implementa RAID por software mediante **mdadm**.

### Instalar mdadm
```
apt install mdadm
```

### Ver discos y particiones para RAID
```
lsblk
fdisk -l
```

### Crear RAID 0 (striping)
```
mdadm --create /dev/md0 --level=0 --raid-devices=2 /dev/sdb /dev/sdc
```

### Crear RAID 1 (mirroring)
```
mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/sdb /dev/sdc
```

### Crear RAID 5 (paridad)
```
mdadm --create /dev/md5 --level=5 --raid-devices=3 /dev/sdb /dev/sdc /dev/sdd
```

### Crear RAID 6 (doble paridad)
```
mdadm --create /dev/md6 --level=6 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde
```

### Ver estado del RAID
```
cat /proc/mdstat
```

Detalles:
```
mdadm --detail /dev/md0
```

### Montar RAID
```
mkfs.ext4 /dev/md0
mount /dev/md0 /mnt
```

Configurar persistencia:
```
mdadm --detail --scan >> /etc/mdadm/mdadm.conf
update-initramfs -u
```

### Añadir disco a RAID
```
mdadm /dev/md0 --add /dev/sdd
```

### Remover disco del RAID
```
mdadm /dev/md0 --fail /dev/sdc
mdadm /dev/md0 --remove /dev/sdc
```

### Reparar RAID
```
mdadm --manage /dev/md0 --add /dev/sdc
```

---

## 5.2 Ajustando el acceso a dispositivos de almacenamiento

### Ver dispositivos de bloque
```
lsblk
blkid
```

### Ajustar permisos de dispositivos
```
chmod 660 /dev/sdb
chown root:disk /dev/sdb
```

### Atributos de disco con smartctl

Instalar:
```
apt install smartmontools
```

Ver salud del disco:
```
smartctl -H /dev/sda
```

Test completo:
```
smartctl -t long /dev/sda
```

Información de atributos:
```
smartctl -a /dev/sda
```

### Ajustar parámetros con hdparm

Ver información:
```
hdparm /dev/sda
```

Ver modo DMA:
```
hdparm -d /dev/sda
```

Activar caché de lectura:
```
hdparm -A1 /dev/sda
```

Definir modo de energía:
```
hdparm -B 127 /dev/sda
```

### Gestión mediante udev

Reglas personalizadas:
```
/etc/udev/rules.d/10-disco.rules
```

Ejemplo:
```
KERNEL=="sdb", OWNER="root", GROUP="disk", MODE="0660"
```

Aplicar reglas:
```
udevadm control --reload-rules
udevadm trigger
```

---

## 5.3 Gestor de Volúmenes Lógicos (LVM)

### Componentes de LVM

```
PV  (Physical Volume)      → discos/particiones
VG  (Volume Group)         → grupo de almacenamiento
LV  (Logical Volume)       → equivalente a particiones flexibles
```

### Instalar LVM (si no está)
/usr:
```
apt install lvm2
```

### Crear un volumen físico

```
pvcreate /dev/sdb
pvcreate /dev/sdc
```

Ver PVs:
```
pvs
pvdisplay
```

### Crear un grupo de volúmenes

```
vgcreate vg_datos /dev/sdb /dev/sdc
```

Ver VGs:
```
vgs
vgdisplay
```

### Crear un volumen lógico

```
lvcreate -n lv_backup -L 20G vg_datos
```

Ver LVs:
```
lvs
lvdisplay
```

### Formatear LV
```
mkfs.ext4 /dev/vg_datos/lv_backup
mount /dev/vg_datos/lv_backup /mnt
```

### Expandir un LV (online)

Aumentar LV:
```
lvresize -L +10G /dev/vg_datos/lv_backup
```

Extender sistema de archivos ext4:
```
resize2fs /dev/vg_datos/lv_backup
```

Para XFS:
```
xfs_growfs /mnt
```

### Reducir un LV (solo ext4, con cuidado)

1) Desmontar:
```
umount /mnt
```

2) Chequear FS:
```
e2fsck -f /dev/vg_datos/lv_backup
```

3) Reducir tamaño FS:
```
resize2fs /dev/vg_datos/lv_backup 10G
```

4) Reducir LV:
```
lvreduce -L 10G /dev/vg_datos/lv_backup
```

### Agregar más discos al VG

```
pvcreate /dev/sdd
vgextend vg_datos /dev/sdd
```

### Migrar datos entre discos (pvmove)

Mover datos de sdb a sdc:
```
pvmove /dev/sdb /dev/sdc
```

### Eliminar LV, VG, PV

Eliminar LV:
```
lvremove /dev/vg_datos/lv_backup
```

Eliminar VG:
```
vgremove vg_datos
```

Eliminar PV:
```
pvremove /dev/sdb
```
