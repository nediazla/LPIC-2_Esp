# 7. Mantenimiento del sistema

## 7.1 Compilar e instalar programas desde el código fuente

Compilar desde código fuente permite instalar software no disponible en repositorios o versiones personalizadas.

### Paquetes necesarios para compilar

Instalar compiladores y herramientas:
```
apt update
apt install build-essential gcc g++ make autoconf automake libtool pkg-config
```

Bibliotecas de desarrollo (dependiendo del proyecto):
```
apt install libssl-dev libncurses-dev libpcre3-dev libreadline-dev zlib1g-dev
```

### Ciclo típico de compilación (Autotools)

Descargar fuente:
```
wget http://sitio.com/paquete.tar.gz
tar -xvf paquete.tar.gz
cd paquete
```

Configurar:
```
./configure
```

Ejemplo con opciones:
```
./configure --prefix=/usr/local --enable-shared
```

Compilar:
```
make
```

Instalar:
```
make install
```

Desinstalar:
```
make uninstall
```
(Únicamente si el paquete provee reglas de desinstalación.)

### Ciclo de compilación con CMake

Instalar CMake:
```
apt install cmake
```

Proceso:
```
mkdir build
cd build
cmake ..
make
make install
```

### Ver archivos instalados por programas compilados manualmente
```
find /usr/local | grep nombre
```

### Limpieza de compilación
```
make clean
make distclean
```

### Aplicar parches
```
patch -p1 < archivo.patch
```

---

## 7.2 Operaciones de Backup

### Tipos de backup
- Completo
- Incremental
- Diferencial
- Snapshot (LVM/Btrfs/ZFS)
- Copia remota segura (rsync + ssh)

### Herramientas principales

#### tar (backup simple)
Crear backup:
```
tar -czf backup.tar.gz /etc /home
```

Restaurar:
```
tar -xzf backup.tar.gz -C /
```

#### rsync (diferencial eficiente)
```
rsync -avz /home /backup
```

Con SSH:
```
rsync -avz -e ssh /home usuario@servidor:/backup
```

#### dd (copia de discos)
```
dd if=/dev/sda of=/backup/sda.img bs=64M status=progress
```

Restaurar:
```
dd if=/backup/sda.img of=/dev/sda
```

#### LVM snapshots

Crear snapshot:
```
lvcreate -L 2G -s -n snap_home /dev/vg/home
```

Montar:
```
mount /dev/vg/snap_home /mnt
```

Eliminar snapshot:
```
lvremove /dev/vg/snap_home
```

#### Btrfs snapshots

```
btrfs subvolume snapshot /datos /datos_snap
```

#### Backups cifrados

tar + gpg:
```
tar -czf - /home | gpg -c > backup.tgz.gpg
```

Restaurar:
```
gpg -d backup.tgz.gpg | tar -xzf -
```

### Programar backups con cron
Agregar al crontab:
```
crontab -e
```

Ejemplo diario:
```
0 3 * * * /usr/local/bin/backup.sh
```

---

## 7.3 Notificar a los usuarios sobre problemas relacionados con el sistema

En sistemas multiusuario es esencial notificar interrupciones y tareas de mantenimiento.

### Enviar mensajes a todos los usuarios conectados

Usando **wall**:
```
wall "Mantenimiento del sistema en 10 minutos."
```

Enviar mensaje desde archivo:
```
wall < mensaje.txt
```

### Enviar mensaje a un usuario específico
```
write usuario
```

Entrar mensaje y terminar con Ctrl + D.

### Notificación mediante shutdown

Cuando se reinicia o apaga un servidor, se puede enviar mensaje a todos:
```
shutdown -r +5 "El sistema se reiniciará en 5 minutos por mantenimiento."
```

Cancelar:
```
shutdown -c
```

### Ver usuarios conectados

```
who
w
users
```

### Enviar correo interno del sistema
(Útil si postfix/mailutils están instalados)

```
echo "Habrá mantenimiento" | mail -s "Aviso" usuario
```

### Logs para revisar actividad de usuarios

```
last
lastb
```

(Usando `/var/log/wtmp` y `/var/log/btmp`)

### Mensajes MOTD

Archivos:
```
/etc/motd
/etc/update-motd.d/
```

Actualizar MOTD:
```
nano /etc/motd
```

Ejemplo mensaje:
```
SISTEMA EN MANTENIMIENTO HOY DE 20:00 A 22:00
```
