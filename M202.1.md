# 1. Servidor de nombres de dominio (DNS)

Bind9 es el servidor DNS estándar en Linux para LPIC-2. Este módulo cubre su instalación, configuración, administración de zonas y seguridad.

---

## 1.1 Configuración básica del servidor DNS

### Instalar Bind9
```
apt update
apt install bind9 bind9-utils bind9-doc
```

### Archivos principales

Configuración global:
```
/etc/bind/named.conf
```

Archivos incluidos:
```
/etc/bind/named.conf.options
/etc/bind/named.conf.local
/etc/bind/named.conf.default-zones
```

Directorio de zonas:
```
/var/cache/bind/
```

### Comprobar sintaxis
```
named-checkconf
```

### Arrancar y habilitar el servicio
```
systemctl start bind9
systemctl enable bind9
systemctl status bind9
```

### Configurar resolución recursiva (DNS caché)

Editar:
```
/etc/bind/named.conf.options
```

Ejemplo básico:
```
options {
    directory "/var/cache/bind";
    recursion yes;
    allow-recursion { 192.168.1.0/24; };
    listen-on { 192.168.1.10; };
    allow-query { any; };
    dnssec-validation auto;
};
```

Reiniciar:
```
systemctl restart bind9
```

### Probar resolución DNS
```
dig @192.168.1.10 google.com
```

---

## 1.2 Crear y mantener zonas DNS

### Declarar una zona en named.conf.local

Archivo:
```
/etc/bind/named.conf.local
```

Ejemplo zona directa:
```
zone "midominio.com" {
    type master;
    file "/etc/bind/db.midominio.com";
};
```

Ejemplo zona inversa:
```
zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/db.192.168.1";
};
```

---

### Crear archivo de zona directa

```
/etc/bind/db.midominio.com
```

Ejemplo:
```
$TTL 86400
@   IN SOA ns1.midominio.com. admin.midominio.com. (
        2025010101 ; Serial
        3600       ; Refresh
        1800       ; Retry
        604800     ; Expire
        86400 )    ; Minimum

    IN NS ns1.midominio.com.
ns1 IN A 192.168.1.10
www IN A 192.168.1.20
mail IN A 192.168.1.30
```

Actualizar el número de **serial** en formato:
```
YYYYMMDDnn
```

### Crear archivo de zona inversa

```
/etc/bind/db.192.168.1
```

Ejemplo:
```
$TTL 86400
@   IN SOA ns1.midominio.com. admin.midominio.com. (
        2025010101
        3600
        1800
        604800
        86400 )

    IN NS ns1.midominio.com.
10  IN PTR ns1.midominio.com.
20  IN PTR www.midominio.com.
30  IN PTR mail.midominio.com.
```

---

### Comprobar archivos de zona

Zona directa:
```
named-checkzone midominio.com /etc/bind/db.midominio.com
```

Zona inversa:
```
named-checkzone 1.168.192.in-addr.arpa /etc/bind/db.192.168.1
```

Comprobar sintaxis general:
```
named-checkconf
```

### Reiniciar DNS
```
systemctl restart bind9
```

### Probar la zona
```
dig @192.168.1.10 www.midominio.com
dig -x 192.168.1.20 @192.168.1.10
```

---

## 1.3 Aplicando seguridad a un servidor DNS

### Limitar consultas DNS

En `named.conf.options`:
```
allow-query { 192.168.1.0/24; };
allow-recursion { 192.168.1.0/24; };
```

### Evitar DNS abierto (open resolver)

Asegurar que **no** exista esto:
```
allow-query { any; };
recursion yes;
```

Si se necesita caching:
```
allow-recursion { trusted; };
```

### Firmar zonas con DNSSEC

Generar claves:
```
dnssec-keygen -a RSASHA256 -b 4096 -n ZONE midominio.com
```

Esto produce archivos:
```
Kmidominio.com.+008+12345.key
Kmidominio.com.+008+12345.private
```

Firmar zona:
```
dnssec-signzone -A -3 randomsalt -o midominio.com db.midominio.com
```

Editar zona en `named.conf.local`:
```
zone "midominio.com" {
    type master;
    file "/etc/bind/db.midominio.com.signed";
    auto-dnssec maintain;
    key-directory "/etc/bind";
};
```

Reiniciar:
```
systemctl restart bind9
```

Verificar DNSSEC:
```
dig +dnssec midominio.com @192.168.1.10
```

### Control de acceso mediante ACLs

En `named.conf.options`:
```
acl "red_local" {
    192.168.1.0/24;
};

allow-query { red_local; };
allow-transfer { none; };
```

### TSIG para transferencias de zona seguras

Crear clave:
```
tsig-keygen -a hmac-sha256 > /etc/bind/tsig.key
```

Incluir clave en Bind:
```
include "/etc/bind/tsig.key";
```

Configurar en master:
```
allow-transfer { key tsig-key; };
```

Configurar en slave:
```
server 192.168.1.10 {
    key tsig-key;
};
```

Probar transferencia:
```
dig AXFR midominio.com @192.168.1.10
```

Si requiere clave:
```
dig AXFR midominio.com @192.168.1.10 -k tsig.key
```

### Habilitar logging

Archivo:
```
/etc/bind/named.conf.local
```

Ejemplo:
```
logging {
    channel default_log {
        file "/var/log/named.log";
        severity info;
        print-time yes;
    };
    category default { default_log; };
};
```

Crear el archivo:
```
touch /var/log/named.log
chown bind:bind /var/log/named.log
```
