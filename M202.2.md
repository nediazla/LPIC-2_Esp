# 2. Servicios HTTP

## 2.1 Configuración básica de Apache

Apache es uno de los servidores web más utilizados. En Linux suele ejecutarse bajo el servicio `apache2`.

### Instalar Apache
```
apt update
apt install apache2
```

### Gestión del servicio
```
systemctl start apache2
systemctl stop apache2
systemctl restart apache2
systemctl enable apache2
systemctl status apache2
```

### Archivos y directorios importantes

Configuración principal:
```
/etc/apache2/apache2.conf
```

Sitios disponibles:
```
/etc/apache2/sites-available/
```

Sitios habilitados:
```
/etc/apache2/sites-enabled/
```

Módulos:
```
/etc/apache2/mods-available/
```

DocumentRoot por defecto:
```
/var/www/html/
```

### Habilitar / deshabilitar módulos

Listar módulos:
```
apache2ctl -M
```

Habilitar:
```
a2enmod rewrite
```

Deshabilitar:
```
a2dismod rewrite
```

Reiniciar para aplicar cambios:
```
systemctl restart apache2
```

### Crear un VirtualHost

Archivo:
```
/etc/apache2/sites-available/misitio.conf
```

Ejemplo:
```
<VirtualHost *:80>
    ServerName ejemplo.com
    DocumentRoot /var/www/ejemplo
    ErrorLog ${APACHE_LOG_DIR}/ejemplo_error.log
    CustomLog ${APACHE_LOG_DIR}/ejemplo_access.log combined
</VirtualHost>
```

Crear directorio:
```
mkdir /var/www/ejemplo
```

Habilitar sitio:
```
a2ensite misitio.conf
systemctl reload apache2
```

Deshabilitar:
```
a2dissite misitio.conf
```

Validar sintaxis:
```
apache2ctl configtest
```

---

## 2.2 Configuración de Apache para HTTPS

### Instalar módulo SSL
```
a2enmod ssl
```

Habilitar sitio SSL por defecto:
```
a2ensite default-ssl
```

Reiniciar:
```
systemctl restart apache2
```

### Generar un certificado autofirmado

```
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout /etc/ssl/private/apache.key \
-out /etc/ssl/certs/apache.crt
```

### Configurar VirtualHost SSL

Archivo:
```
/etc/apache2/sites-available/ejemplo-ssl.conf
```

Ejemplo:
```
<VirtualHost *:443>
    ServerName ejemplo.com
    DocumentRoot /var/www/ejemplo

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/apache.crt
    SSLCertificateKeyFile /etc/ssl/private/apache.key
</VirtualHost>
```

Habilitar:
```
a2ensite ejemplo-ssl.conf
systemctl reload apache2
```

### Redirigir HTTP a HTTPS

En VirtualHost port 80:
```
Redirect permanent / https://ejemplo.com/
```

---

## 2.3 Implementando Squid como proxy cache

Squid puede funcionar como proxy HTTP, filtrado y caché.

### Instalar Squid
```
apt install squid
systemctl enable --now squid
```

### Archivo principal
```
/etc/squid/squid.conf
```

### Ver puerto de escucha
Por defecto:
```
http_port 3128
```

### Configurar red permitida

En `squid.conf`:
```
acl redlocal src 192.168.1.0/24
http_access allow redlocal
http_access deny all
```

Reiniciar:
```
systemctl restart squid
```

### Ver logs

```
/var/log/squid/access.log
/var/log/squid/cache.log
```

### Configurar como proxy en un cliente

En navegador:
```
Proxy HTTP: 192.168.1.10
Puerto: 3128
```

Con curl:
```
curl -x 192.168.1.10:3128 http://google.com
```

### Limpiar caché
```
squid -k purge
```

### Recargar configuración
```
squid -k reconfigure
```

### Cache de objetos

Directivas útiles:
```
maximum_object_size 512 MB
cache_mem 256 MB
cache_dir ufs /var/spool/squid 20000 16 256
```

---

## 2.4 Implementando Nginx como servidor web y como proxy inverso

### Instalar Nginx
```
apt install nginx
systemctl start nginx
systemctl enable nginx
```

### Directorios importantes

Configuración principal:
```
/etc/nginx/nginx.conf
```

Sitios disponibles:
```
/etc/nginx/sites-available/
```

Sitios habilitados:
```
/etc/nginx/sites-enabled/
```

DocumentRoot por defecto:
```
/var/www/html/
```

### Crear un servidor web básico

Ejemplo de sitio:
```
server {
    listen 80;
    server_name ejemplo.com;
    root /var/www/ejemplo;
    index index.html;
}
```

Habilitar sitio:
```
ln -s /etc/nginx/sites-available/ejemplo /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

---

### Nginx como proxy inverso

Ejemplo:
```
server {
    listen 80;
    server_name app.midominio.com;

    location / {
        proxy_pass http://127.0.0.1:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Balanceo de carga simple

```
upstream backend {
    server 192.168.1.20;
    server 192.168.1.21;
}

server {
    listen 80;
    location / {
        proxy_pass http://backend;
    }
}
```

---

### Nginx con HTTPS

Generar certificado:
```
openssl req -new -newkey rsa:2048 -nodes -x509 \
-keyout /etc/ssl/private/nginx.key \
-out /etc/ssl/certs/nginx.crt
```

Configurar VirtualHost SSL:
```
server {
    listen 443 ssl;
    server_name ejemplo.com;

    ssl_certificate /etc/ssl/certs/nginx.crt;
    ssl_certificate_key /etc/ssl/private/nginx.key;

    root /var/www/ejemplo;
}
```

Redirección HTTP → HTTPS:
```
server {
    listen 80;
    return 301 https://$host$request_uri;
}
```

