# 4. Gestión de redes de clientes

## 4.1 Configuración de DHCP

DHCP asigna direcciones IP y parámetros de red automáticamente a los clientes.

### Instalar servidor DHCP (ISC DHCP)
```
apt update
apt install isc-dhcp-server
```

### Archivo principal de configuración
```
/etc/dhcp/dhcpd.conf
```

### Definir un rango de direcciones

Ejemplo básico:
```
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.50 192.168.1.150;
    option routers 192.168.1.1;
    option domain-name-servers 8.8.8.8, 1.1.1.1;
    option domain-name "midominio.com";
    default-lease-time 600;
    max-lease-time 7200;
}
```

### Asignación estática por MAC
```
host servidor {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.168.1.10;
}
```

### Seleccionar interfaz donde correr DHCP
Archivo:
```
/etc/default/isc-dhcp-server
```

Editar:
```
INTERFACESv4="eth0"
```

### Reiniciar servicio
```
systemctl restart isc-dhcp-server
systemctl status isc-dhcp-server
```

### Ver concesiones actuales
```
cat /var/lib/dhcp/dhcpd.leases
```

---

## 4.2 Autenticación PAM

PAM (Pluggable Authentication Modules) permite definir cómo se autentican usuarios.

### Directorio de configuración PAM
```
/etc/pam.d/
```

### Archivo principal (incluye políticas globales)
```
/etc/pam.conf
```

### Líneas típicas de PAM

Formato:
```
tipo  control   módulo               argumentos
```

Ejemplo:
```
auth   required   pam_unix.so
account required   pam_unix.so
password required  pam_unix.so
session required   pam_unix.so
```

### Tipos de módulos

- **auth**    → autenticación (contraseñas, tokens)
- **account** → políticas de acceso (expiración, bloqueo)
- **password** → cambio/modificación de contraseñas
- **session** → acciones al iniciar/cerrar sesión

### Control flags comunes

- `required` → obligatorio, pero sigue comprobando
- `requisite` → si falla, se corta inmediatamente
- `sufficient` → si funciona, no se prueban más módulos
- `optional` → se usa si no hay otros módulos

### Bloqueo de cuentas con pam_tally2 (LPIC clásico)

Agregar en `/etc/pam.d/common-auth`:
```
auth required pam_tally2.so deny=5 unlock_time=900
```

Ver intentos:
```
pam_tally2
pam_tally2 -u usuario
```

Resetear:
```
pam_tally2 -u usuario -r
```

### Requerir contraseñas fuertes con pam_cracklib
(En algunas distros está como pam_pwquality)

```
password required pam_pwquality.so retry=3 minlen=12
```

---

## 4.3 Clientes LDAP

Permite que Linux use un servidor LDAP para autenticarse y consultar usuarios.

### Instalar herramientas LDAP
```
apt install ldap-utils libnss-ldap libpam-ldap
```

### Archivo principal del cliente LDAP
```
/etc/ldap/ldap.conf
```

Ejemplo:
```
BASE    dc=midominio,dc=com
URI     ldap://192.168.1.10
TLS_REQCERT allow
```

### Configuración NSS para usar LDAP

Editar:
```
/etc/nsswitch.conf
```

Cambiar líneas:
```
passwd:    files ldap
group:     files ldap
shadow:    files ldap
```

### Probar conexión LDAP
```
ldapsearch -x -H ldap://192.168.1.10 -b dc=midominio,dc=com
```

Autenticación simple:
```
ldapsearch -x -D cn=admin,dc=midominio,dc=com -W -b dc=midominio,dc=com
```

---

## 4.4 Configurando un servidor OpenLDAP

### Instalar OpenLDAP y utilidades
```
apt install slapd ldap-utils
```

Reconfigurar si es necesario:
```
dpkg-reconfigure slapd
```

### Archivos y directorios importantes

Base de datos:
```
/var/lib/ldap/
```

Configuración dinámica (cn=config):
```
/etc/ldap/slapd.d/
```

### Ver estructura LDAP
```
ldapsearch -x -LLL -H ldap://localhost -b dc=midominio,dc=com
```

### Crear una unidad organizativa (OU)

Archivo `ou.ldif`:
```
dn: ou=usuarios,dc=midominio,dc=com
objectClass: organizationalUnit
ou: usuarios
```

Aplicar:
```
ldapadd -x -D cn=admin,dc=midominio,dc=com -W -f ou.ldif
```

### Crear un usuario LDAP

Archivo `usuario.ldif`:
```
dn: uid=juan,ou=usuarios,dc=midominio,dc=com
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
cn: Juan Perez
sn: Perez
uid: juan
uidNumber: 10001
gidNumber: 10001
homeDirectory: /home/juan
loginShell: /bin/bash
userPassword: {CRYPT}$6$...
```

Agregar:
```
ldapadd -x -D cn=admin,dc=midominio,dc=com -W -f usuario.ldif
```

Generar contraseña:
```
slappasswd
```

### Modificar una entrada
```
ldapmodify -x -D cn=admin,dc=midominio,dc=com -W -f archivo.ldif
```

### Borrar una entrada
```
ldapdelete -x -D cn=admin,dc=midominio,dc=com -W uid=juan,ou=usuarios,dc=midominio,dc=com
```

### Crear grupos LDAP

Archivo `grupo.ldif`:
```
dn: cn=admins,ou=grupos,dc=midominio,dc=com
objectClass: posixGroup
cn: admins
gidNumber: 20000
memberUid: juan
```

Agregar:
```
ldapadd -x -D cn=admin,dc=midominio,dc=com -W -f grupo.ldif
```

### Activar TLS en OpenLDAP (seguridad básica)

Crear archivo de certificado:
```
openssl req -new -x509 -days 365 -nodes \
-out /etc/ssl/certs/ldap.crt \
-keyout /etc/ssl/private/ldap.key
```

Archivo `tls.ldif`:
```
dn: cn=config
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.crt
-
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.key
```

Aplicar:
```
ldapmodify -Y EXTERNAL -H ldapi:/// -f tls.ldif
```

### Reiniciar OpenLDAP
```
systemctl restart slapd
```

### Probar conexión segura
```
ldapsearch -H ldaps://localhost -x -b dc=midominio,dc=com
```
