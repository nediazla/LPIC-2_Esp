# 5. Servicios de E-Mail

Linux utiliza varios componentes para manejar correo electrónico:

- **MTA** (Mail Transfer Agent): Postfix, Exim, Sendmail  
- **MDA** (Mail Delivery Agent): Dovecot, Procmail  
- **MUA** (Mail User Agent): mutt, alpine, Thunderbird  
- **Protocolos de acceso**: IMAP (143/993), POP3 (110/995)

Este módulo cubre Postfix como MTA, Dovecot como MDA y POP/IMAP para acceso.

---

## 5.1 Utilizando servidores de E-mail

### Instalar Postfix (MTA)
```
apt update
apt install postfix mailutils
```

Durante la instalación elegir:
```
Internet Site
```

### Archivos importantes
Postfix principal:
```
/etc/postfix/main.cf
```

Configuración avanzada:
```
/etc/postfix/master.cf
```

Cola de correo:
```
/var/spool/postfix/
```

### Estado del servicio
```
systemctl start postfix
systemctl enable postfix
systemctl status postfix
```

### Enviar correo desde terminal
```
echo "Mensaje de prueba" | mail -s "Asunto" usuario@midominio.com
```

### Ver la cola de correo
```
postqueue -p
```

Vaciar cola:
```
postsuper -d ALL
```

### Ver logs de correo
```
tail -f /var/log/mail.log
tail -f /var/log/mail.err
```

---

## 5.2 Gestionar la entrega de E-Mail (MDA y Postfix internals)

### Entrega local con Postfix

En `/etc/postfix/main.cf`:
```
myhostname = mail.midominio.com
mydomain = midominio.com
myorigin = /etc/mailname
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
```

Recargar configuración:
```
systemctl reload postfix
```

### Aliases locales

Archivo:
```
/etc/aliases
```

Ejemplo:
```
root: admin@midominio.com
ventas: juan
```

Actualizar aliases:
```
newaliases
```

### Redirección permanente de correo
En `.forward` del usuario:
```
usuario@otrodominio.com
```

### Entrega filtrada con Procmail (MDA clásico)

Archivo:
```
~/.procmailrc
```

Ejemplo:
```
:0:
* ^Subject:.*Urgente
urgentes
```

---

## 5.3 Gestionar el acceso al buzón de correo (POP3/IMAP)

Dovecot es el estándar moderno para POP3 e IMAP.

### Instalar Dovecot
```
apt install dovecot-imapd dovecot-pop3d dovecot-core
```

### Servicios incluidos
```
systemctl status dovecot
```

Protocolos:
```
IMAP  143 (993 SSL)
POP3  110 (995 SSL)
```

### Archivos importantes de Dovecot
Configuración principal:
```
/etc/dovecot/dovecot.conf
```

Directorio base:
```
/etc/dovecot/conf.d/
```

### Habilitar IMAP y POP3

Archivo:
```
/etc/dovecot/conf.d/10-master.conf
```

Debe incluir:
```
protocols = imap pop3
```

Reiniciar:
```
systemctl restart dovecot
```

### Ubicación del buzón

Por defecto (Maildir):
```
~/Maildir/
```

Cambiar a mailbox tradicional:
```
mail_location = mbox:~/mail:INBOX=/var/mail/%u
```

### Probar acceso IMAP/POP

IMAP:
```
openssl s_client -connect localhost:993
```

POP3:
```
openssl s_client -connect localhost:995
```

### Autenticación en Dovecot

Archivo:
```
/etc/dovecot/conf.d/10-auth.conf
```

Forzar autenticación segura:
```
disable_plaintext_auth = yes
```

### Cifrado SSL/TLS en Dovecot

Archivo:
```
/etc/dovecot/conf.d/10-ssl.conf
```

Ejemplo:
```
ssl = required
ssl_cert = </etc/ssl/certs/mail.crt
ssl_key  = </etc/ssl/private/mail.key
```

Reiniciar:
```
systemctl restart dovecot
```

### Ver logs de Dovecot
```
journalctl -u dovecot
tail -f /var/log/mail.log
```

### Herramientas útiles

Ver usuarios conectados:
```
doveadm who
```

Revisar estado del servidor:
```
doveadm director status
```
