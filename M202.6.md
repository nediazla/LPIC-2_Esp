# 6. Seguridad del sistema

## 6.1 Configurar un router

Linux puede operar como router activando el reenvío de paquetes y configurando reglas de filtrado y NAT.

### Habilitar IP forwarding temporalmente
```
sysctl -w net.ipv4.ip_forward=1
```

### Habilitar IP forwarding permanentemente

Editar:
```
/etc/sysctl.conf
```

Agregar:
```
net.ipv4.ip_forward=1
```

Aplicar:
```
sysctl -p
```

### Configurar NAT (Masquerading)

Ejemplo: red interna 192.168.1.0/24 sale por `eth0`:
```
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

Permitir reenvío:
```
iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
```

### Routing estático

Agregar ruta:
```
ip route add 10.10.0.0/16 via 192.168.1.1
```

Eliminar:
```
ip route del 10.10.0.0/16
```

Mostrar tabla:
```
ip route
```

### Routing avanzado (policy routing)

Agregar tabla:
```
echo "200 custom" >> /etc/iproute2/rt_tables
```

Regla por IP origen:
```
ip rule add from 192.168.50.10 table custom
ip route add default via 192.168.50.1 table custom
```

---

## 6.2 Gestionar servidores FTP

Examen LPIC-2 espera conocimientos básicos de **vsftpd** y **ProFTPD**.

---

### Servidor FTP vsftpd

Instalar:
```
apt install vsftpd
```

Archivo principal:
```
/etc/vsftpd.conf
```

Iniciar servicio:
```
systemctl restart vsftpd
systemctl enable vsftpd
```

#### Opciones esenciales

Permitir usuarios locales:
```
local_enable=YES
```

Permitir subida de archivos:
```
write_enable=YES
```

Chroot (aislar usuarios):
```
chroot_local_user=YES
```

Especificar directorio anónimo:
```
anon_root=/srv/ftp
```

Desactivar FTP anónimo (recomendado):
```
anonymous_enable=NO
```

#### Logs

```
/var/log/vsftpd.log
journalctl -u vsftpd
```

---

### Servidor ProFTPD

Instalar:
```
apt install proftpd-basic
```

Archivo principal:
```
/etc/proftpd/proftpd.conf
```

Modo independiente (standalone):
```
ServerType standalone
```

Restringir root:
```
RootLogin off
```

Habilitar chroot:
```
DefaultRoot ~
```

Logs:
```
/var/log/proftpd/
```

---

## 6.3 Secure Shell (SSH)

SSH provee autenticación segura y acceso remoto cifrado.

### Instalar servidor SSH
```
apt install openssh-server
```

Ver estado:
```
systemctl status ssh
```

### Archivo de configuración principal
```
/etc/ssh/sshd_config
```

### Seguridad recomendada

Desactivar login de root:
```
PermitRootLogin no
```

Desactivar autenticación por contraseña:
```
PasswordAuthentication no
```

Habilitar solo llaves:
```
PubkeyAuthentication yes
```

Limitar usuarios:
```
AllowUsers user1 user2
```

Cambiar puerto:
```
Port 2222
```

Aplicar cambios:
```
systemctl restart ssh
```

### Generación de llaves SSH

En cliente:
```
ssh-keygen -t rsa -b 4096
```

Copiar llave al servidor:
```
ssh-copy-id usuario@servidor
```

Conectarse:
```
ssh usuario@servidor
```

### Túneles SSH

Túnel local:
```
ssh -L 8080:localhost:80 usuario@servidor
```

Túnel remoto:
```
ssh -R 2222:localhost:22 usuario@servidor
```

---

## 6.4 Tareas de seguridad

### Escaneo de puertos

Usando nmap:
```
nmap -sV -O 192.168.1.10
```

Escaneo rápido:
```
nmap -F 192.168.1.0/24
```

### Ver procesos sospechosos
```
ps aux --sort=-%cpu
pstree -p
lsof -i
```

### Analizar conexiones de red
```
ss -tulnp
netstat -antp     (si instalado)
```

### Ver integridad de archivos: AIDE

Instalar:
```
apt install aide
```

Inicializar base:
```
aideinit
mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
```

Verificar:
```
aide --check
```

### Fail2ban

Instalar:
```
apt install fail2ban
```

Ver estado:
```
systemctl status fail2ban
```

Banear intentos con jail SSH:
```
jail.local:
[ssh]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 4
```

Reiniciar:
```
systemctl restart fail2ban
```

Logs:
```
/var/log/fail2ban.log
```

### SELinux / AppArmor (LPIC pide conceptos)

Ver estado AppArmor:
```
aa-status
```

Deshabilitar perfil:
```
aa-disable /etc/apparmor.d/usr.sbin.mysqld
```

Habilitar:
```
aa-enforce /etc/apparmor.d/usr.sbin.mysqld
```

---

## 6.5 OpenVPN

OpenVPN permite crear VPNs seguras basadas en TLS/SSL.

### Instalar OpenVPN
```
apt install openvpn easy-rsa
```

### Directorio de configuración
```
/etc/openvpn/
```

### Crear PKI con easy-rsa

Crear directorio:
```
make-cadir /etc/openvpn/easy-rsa
cd /etc/openvpn/easy-rsa
```

Inicializar PKI:
```
./easyrsa init-pki
```

Crear CA:
```
./easyrsa build-ca
```

Crear certificado para servidor:
```
./easyrsa build-server-full servidor nopass
```

Crear certificado para cliente:
```
./easyrsa build-client-full cliente1 nopass
```

Generar Diffie-Hellman:
```
./easyrsa gen-dh
```

### Configurar servidor OpenVPN

Archivo:
```
/etc/openvpn/server.conf
```

Ejemplo básico:
```
port 1194
proto udp
dev tun

ca   /etc/openvpn/easy-rsa/pki/ca.crt
cert /etc/openvpn/easy-rsa/pki/issued/servidor.crt
key  /etc/openvpn/easy-rsa/pki/private/servidor.key
dh   /etc/openvpn/easy-rsa/pki/dh.pem

server 10.8.0.0 255.255.255.0

push "redirect-gateway def1"
push "dhcp-option DNS 8.8.8.8"

keepalive 10 120
persist-key
persist-tun

user nobody
group nogroup
```

### Iniciar servidor VPN
```
systemctl start openvpn@server
systemctl enable openvpn@server
```

### Generar archivo .ovpn para cliente

Crear archivo:
```
client
dev tun
proto udp
remote midominio.com 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert cliente1.crt
key cliente1.key
```

### Verificar servicio
```
systemctl status openvpn@server
```

### Logs
```
/var/log/openvpn.log
journalctl -u openvpn
```

---

# Fin del tema 6 (Seguridad del sistema)
